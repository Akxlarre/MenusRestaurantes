---
import Layout from "../layouts/Layout.astro";
import PublicNavbar from "../components/public/PublicNavbar.astro";
import Hero from "../components/public/Hero.astro";
import MenuCard from "../components/public/MenuCard.astro";
import SakuraPetals from "../components/public/SakuraPetals.astro";
import RealtimeMenu from "../components/public/RealtimeMenu.astro";
import { supabase } from "../lib/supabase";

// Fetch Categories
const { data: categories, error: catError } = await supabase
	.from("categories")
	.select("*")
	.order("display_order", { ascending: true });

if (catError) {
	console.error("Error fetching categories:", catError);
}

// Fetch Menu Items with Categories
const { data: menuItems, error } = await supabase
	.from("menu_items")
	.select(
		`
		*,
		menu_item_categories (
			categories (
				id,
				name_es,
				name_zh,
				slug
			)
		)
	`,
	)
	.order("price", { ascending: true });

if (error) {
	console.error("Error fetching menu:", error);
}

// Group items by category (products can appear in multiple sections)
const groupedItems: Record<string, typeof menuItems> = {};

categories?.forEach((cat) => {
	groupedItems[cat.slug] =
		menuItems?.filter((item) =>
			item.menu_item_categories?.some(
				(mic: any) => mic.categories.slug === cat.slug,
			),
		) || [];
});

// Filter empty categories
const activeCategories =
	categories?.filter((cat) => (groupedItems[cat.slug]?.length ?? 0) > 0) ||
	[];
---

<Layout>
	<SakuraPetals />
	<PublicNavbar />
	<Hero />

	<!-- Scroll target para el botón del hero -->
	<div id="menu"></div>

	<!-- Main con mismo fondo que navbar -->
	<main
		class="section-spacing"
		style="background: rgba(247, 247, 242, 0.98);"
	>
		<div class="container mx-auto px-6 md:px-12 lg:px-16 max-w-7xl">
			{
				activeCategories.map((cat) => (
					<section id={cat.slug} class="mb-24 scroll-mt-24">
						{/* Título de sección mejorado */}
						<div class="mb-12">
							<p class="text-sm font-noto-serif text-matcha-oscuro tracking-wider uppercase mb-2">
								{cat.name_zh}
							</p>
							<h2 class="text-4xl md:text-5xl font-playfair font-bold text-sumi-ink border-l-4 border-matcha pl-6">
								{cat.name_es}
							</h2>
						</div>

						{/* Lista simple de productos */}
						<div class="flex flex-col gap-5">
							{groupedItems[cat.slug]?.map((item: any) => (
								<MenuCard
									id={item.id}
									name_es={item.name_es}
									name_zh={item.name_zh}
									price={item.price}
									is_available={item.is_available}
								/>
							))}
						</div>
					</section>
				))
			}

			{
				(!menuItems || menuItems.length === 0) && (
					<div class="text-center py-32 opacity-50">
						<p class="font-inter text-lg text-sumi-ink">
							El menú se está cargando o está vacío.
						</p>
					</div>
				)
			}
		</div>
	</main>

	<!-- Suscripción Realtime para actualizaciones en vivo -->
	<RealtimeMenu />

	<!-- Footer Zen Moderno -->
	<footer class="bg-sumi-ink text-arroz py-8">
		<div class="container mx-auto text-center">
			<p class="font-inter text-sm opacity-80">
				Tecnología por <a href="https://aiondevs.cl" target="_blank" rel="noopener noreferrer" class="font-semibold text-matcha hover:text-matcha-oscuro transition-colors">AION DEVS</a>
			</p>
		</div>
	</footer>
</Layout>
